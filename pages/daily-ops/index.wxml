<view class="page-shell ui-page pb-40rpx">
  <view class="ui-header pb-16rpx">
    <view>
      <view class="text-36rpx font-bold text-hex-111827">每日操作</view>
      <view class="text-24rpx text-hex-6B7280 mt-8rpx">查看按用户分组的交易流水</view>
    </view>
  </view>

  <!-- 1. 日期选择器 -->
  <view class="ui-section">
    <view
      class="bg-white rounded-24rpx p-24rpx flex justify-between items-center shadow-sm active:bg-hex-F9FAFB transition-colors"
      bindtap="showCalendar">
      <view class="flex items-center gap-16rpx">
        <view class="w-80rpx h-80rpx rounded-full bg-hex-F0FDFA flex items-center justify-center">
          <van-icon name="calendar-o" color="#0D9488" size="20px" />
        </view>
        <view class="flex flex-col">
          <text class="text-24rpx text-hex-9CA3AF">当前查看日期</text>
          <text class="text-32rpx font-bold font-numeric text-hex-1F2937">{{ selectedDate }}</text>
        </view>
      </view>
      <van-icon name="arrow-down" color="#9CA3AF" size="16px" />
    </view>
  </view>

  <!-- 2. 用户分组列表 -->
  <view class="ui-section mt-24rpx">
    <van-empty wx:if="{{ !groupedTransactions.length }}" description="该日暂无操作记录" />

    <van-collapse value="{{ activeNames }}" bind:change="onCollapseChange" border="{{ false }}">
      <van-collapse-item wx:for="{{ groupedTransactions }}" wx:key="username" name="{{ item.user.username }}"
        custom-class="mb-24rpx rounded-24rpx overflow-hidden shadow-sm bg-white" content-class="!p-0">

        <!-- 自定义标题槽：显示用户信息和资产概览 -->
        <view slot="title" class="flex flex-col py-8rpx">
          <view class="flex items-center gap-16rpx">
            <text class="font-bold text-28rpx text-hex-1F2937">{{ item.user.username }}</text>
            <view wx:if="{{ item.user.isAiAgent }}"
              class="bg-hex-EFF6FF text-hex-3B82F6 text-20rpx px-12rpx py-4rpx rounded border border-hex-DBEAFE">AI
            </view>
            <text class="text-24rpx text-hex-9CA3AF">({{ item.txs.length }}笔)</text>
          </view>
          <view class="flex gap-24rpx mt-8rpx">
            <text class="text-22rpx text-hex-6B7280 font-mono">资产: ¥{{ item.user.stats.totalAssets }}</text>
            <text class="text-22rpx text-hex-6B7280 font-mono">现金: ¥{{ item.user.stats.cash }}</text>
          </view>
        </view>

        <!-- 内部交易列表 -->
        <view class="divide-y divide-hex-F3F4F6">
          <view wx:for="{{ item.txs }}" wx:for-item="tx" wx:key="id" class="p-32rpx bg-white">
            <!-- 头部：类型与时间 -->
            <view class="flex justify-between items-center mb-16rpx">
              <view class="flex items-center gap-16rpx">
                <view
                  class="text-22rpx px-16rpx py-6rpx rounded-8rpx font-medium {{ tx.status === 'confirmed' ? 'bg-hex-ECFDF5 text-hex-10B981' : 'bg-hex-FFFBEB text-hex-F59E0B' }}">
                  {{ tx.typeLabel }}
                </view>
                <text class="font-bold text-hex-1F2937 text-28rpx truncate max-w-400rpx">{{ tx.fundName || tx.fundCode
                  }}</text>
              </view>
              <text class="text-22rpx font-mono text-hex-9CA3AF">{{ tx.time }}</text>
            </view>

            <!-- 详情：申报与成交 -->
            <view class="flex justify-between items-center bg-hex-F9FAFB p-20rpx rounded-16rpx">
              <view class="flex flex-col">
                <text class="text-20rpx text-hex-9CA3AF mb-4rpx">申报详情</text>
                <text class="text-28rpx font-mono font-medium text-hex-4B5563">{{ tx.orderDetail }}</text>
              </view>

              <view class="text-right flex flex-col items-end">
                <block wx:if="{{ tx.status === 'confirmed' }}">
                  <text class="text-20rpx text-hex-9CA3AF mb-4rpx">确认金额</text>
                  <view class="text-28rpx font-bold font-numeric text-hex-1F2937">¥{{ tx.confirmedAmount }}</view>
                </block>
                <block wx:else>
                  <text class="text-20rpx text-hex-9CA3AF mb-4rpx">状态</text>
                  <view class="text-24rpx text-hex-F59E0B italic flex items-center gap-8rpx">
                    <van-loading size="12px" color="#F59E0B" /> 待确认
                  </view>
                </block>
              </view>
            </view>

            <!-- 备注 -->
            <view wx:if="{{ tx.note }}" class="mt-16rpx text-22rpx text-hex-6B7280 italic flex items-start gap-8rpx">
              <van-icon name="comment-o" class="mt-4rpx" />
              <text>{{ tx.note }}</text>
            </view>
          </view>
        </view>
      </van-collapse-item>
    </van-collapse>
  </view>

  <!-- 3. 日历弹窗 -->
  <van-calendar show="{{ showCalendar }}" color="#0D9488" show-confirm="{{ false }}" min-date="{{ minDate }}"
    max-date="{{ maxDate }}" bind:close="onCalendarClose" bind:confirm="onCalendarConfirm" />

  <van-toast id="van-toast" />
</view>