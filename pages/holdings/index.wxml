<view class="page-shell ui-page pb-40rpx">
  <!-- 顶部导航区 -->
  <view class="ui-header flex items-end pb-16rpx">
    <view>
      <view class="text-36rpx font-bold text-hex-111827">持仓组合</view>
      <view class="text-24rpx text-hex-6B7280 mt-8rpx">
        共 <text class="font-bold text-hex-0D9488">{{ holdings.length }}</text> 只基金
      </view>
    </view>
  </view>

  <!-- 1. 资产概览卡片 (精致版) -->
  <view class="ui-section">
    <view class="relative overflow-hidden rounded-32rpx bg-hex-0D9488 text-white shadow-lg">
      <!-- 装饰背景 -->
      <view class="absolute -right-32rpx -top-80rpx w-300rpx h-300rpx bg-white opacity-10 rounded-full blur-2xl"></view>
      <view class="absolute -left-80rpx -bottom-80rpx w-300rpx h-300rpx bg-hex-0F766E opacity-40 rounded-full blur-xl">
      </view>

      <view class="relative z-10 p-40rpx">
        <view class="flex justify-between items-start mb-8rpx">
          <view class="text-24rpx opacity-80 font-medium tracking-wide">总预估市值 (元)</view>
          <view class="text-24rpx px-16rpx py-4rpx bg-white bg-opacity-20 rounded-full flex items-center">
            <text>{{ summary.totalPercentageChange }}%</text>
            <van-icon name="{{ summary.totalPercentageChange >= 0 ? 'ascending' : 'descending' }}" class="ml-8rpx" />
          </view>
        </view>
        <view class="text-60rpx font-bold font-numeric mb-40rpx tracking-tight">{{ summary.totalEstimateAmount }}</view>

        <view class="flex border-t border-white border-opacity-10 pt-32rpx">
          <view class="flex-1 pr-32rpx border-r border-white border-opacity-10">
            <view class="text-24rpx opacity-70 mb-8rpx">当日盈亏</view>
            <view class="font-bold font-numeric text-36rpx truncate">
              {{ summary.totalProfitLoss >= 0 ? '+' : '' }}{{ summary.totalProfitLoss }}
            </view>
          </view>
          <view class="flex-1 pl-32rpx">
            <!-- 替换点：原持有收益 -> 改为昨日市值 -->
            <view class="text-24rpx opacity-70 mb-8rpx">昨日市值</view>
            <view class="font-bold font-numeric text-36rpx truncate">
              {{ summary.totalHoldingAmount }}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. 行情简报 (紧凑版) -->
  <view class="ui-section mt-16rpx">
    <scroll-view scroll-x class="whitespace-nowrap w-full" enable-flex>
      <view class="flex gap-16rpx pb-8rpx">
        <view wx:for="{{ indices }}" wx:key="code"
          class="bg-white rounded-16rpx p-20rpx min-w-170rpx shadow-sm flex flex-col justify-center">
          <view class="text-24rpx text-hex-6B7280 mb-8rpx">{{ item.name }}</view>
          <view class="flex items-baseline gap-8rpx">
            <text
              class="text-32rpx font-bold font-numeric {{ item.changeRate >= 0 ? 'text-hex-EF4444' : 'text-hex-22C55E' }}">
              {{ item.value }}
            </text>
            <text class="text-20rpx font-numeric {{ item.changeRate >= 0 ? 'text-hex-EF4444' : 'text-hex-22C55E' }}">
              {{ item.changeRate }}%
            </text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 3. 持仓列表 (高密度布局) -->
  <view class="px-32rpx pb-32rpx">
    <view class="flex items-center justify-between mb-24rpx mt-32rpx">
      <text class="text-28rpx font-bold text-hex-374151">我的持仓</text>
      <van-icon name="filter-o" size="16px" color="#9CA3AF" />
    </view>

    <van-empty wx:if="{{ !holdings.length }}" description="暂无持仓" />

    <view class="space-y-24rpx">
      <view wx:for="{{ holdings }}" wx:key="code"
        class="bg-white rounded-24rpx shadow-sm overflow-hidden active:scale-95 transition-transform" bindtap="toDetail"
        data-code="{{ item.code }}">

        <!-- 卡片主体区域 -->
        <view class="p-28rpx">
          <!-- 头部：名称与代码 -->
          <view class="flex justify-between items-start mb-24rpx">
            <view class="flex flex-col">
              <view class="font-bold text-hex-111827 text-28rpx truncate max-w-400rpx">{{ item.name }}</view>
              <view class="text-20rpx text-hex-9CA3AF font-mono mt-4rpx">{{ item.code }}</view>
            </view>

            <!-- 待确认胶囊 (紧凑) -->
            <view wx:if="{{ item.pendingTransactions.length }}" class="flex flex-col items-end gap-8rpx">
              <view wx:for="{{ item.pendingTransactions }}" wx:for-item="ptx" wx:key="id"
                class="text-20rpx px-12rpx py-4rpx rounded border flex items-center gap-8rpx {{ ptx.type === 'buy' ? 'bg-hex-FEF2F2 text-hex-EF4444 border-hex-FEE2E2' : 'bg-hex-F0FDF4 text-hex-22C55E border-hex-DCFCE7' }}">
                <van-icon name="clock-o" />
                <text>{{ ptx.typeLabel }}</text>
              </view>
            </view>
          </view>

          <!-- 数据三列布局 -->
          <view class="flex items-end justify-between">
            <!-- 1. 持有市值 (昨日) -->
            <view class="flex-1">
              <view class="text-20rpx text-hex-9CA3AF mb-4rpx">持有市值</view>
              <view class="text-28rpx font-bold font-numeric text-hex-1F2937">¥{{ item.holdingAmount }}</view>
            </view>

            <!-- 2. 持有盈亏 (列表项本身有此数据，可以展示) -->
            <view class="flex-1 text-center border-l border-hex-F3F4F6">
              <view class="text-20rpx text-hex-9CA3AF mb-4rpx">累计收益</view>
              <view
                class="text-28rpx font-bold font-numeric {{ item.holdingProfitAmount >= 0 ? 'text-hex-EF4444' : 'text-hex-22C55E' }}">
                {{ item.holdingProfitAmount >= 0 ? '+' : '' }}{{ item.holdingProfitAmount }}
              </view>
            </view>

            <!-- 3. 今日估算 (最重要，视觉最重) -->
            <view class="flex-1 text-right border-l border-hex-F3F4F6 pl-16rpx">
              <view class="text-20rpx text-hex-9CA3AF mb-4rpx">今日估算</view>
              <block wx:if="{{ item.todayEstimateAmount !== null && item.todayEstimateAmount != 0 }}">
                <view
                  class="text-32rpx font-bold font-numeric {{ item.todayProfitAmount >= 0 ? 'text-hex-EF4444' : 'text-hex-22C55E' }}">
                  {{ item.todayProfitAmount >= 0 ? '+' : '' }}{{ item.todayProfitAmount }}
                </view>
                <view
                  class="text-20rpx font-numeric {{ item.percentageChange >= 0 ? 'text-hex-EF4444' : 'text-hex-22C55E' }}">
                  {{ item.percentageChange >= 0 ? '+' : '' }}{{ item.percentageChange }}%
                </view>
              </block>
              <view wx:else class="text-24rpx text-hex-D1D5DB italic">--</view>
            </view>
          </view>
        </view>

        <!-- 卡片底部 (Footer) -->
        <view class="bg-hex-F9FAFB px-28rpx py-16rpx flex justify-between items-center border-t border-hex-F3F4F6">
          <!-- 交易热点图 -->
          <view class="flex items-center gap-8rpx">
            <view wx:if="{{ !item.recentTransactions.length }}" class="text-20rpx text-hex-D1D5DB">近期无交易</view>
            <view wx:for="{{ item.formattedRecentTxs }}" wx:for-item="tx" wx:key="id"
              class="w-16rpx h-16rpx rounded-full {{ tx.colorClass }}"></view>
          </view>

          <!-- 7天安全状态 -->
          <view wx:if="{{ item.lastBuyStatus }}" class="flex items-center gap-8rpx">
            <view
              class="w-12rpx h-12rpx rounded-full {{ item.lastBuyStatus.isSafe ? 'bg-hex-10B981' : 'bg-hex-F59E0B animate-pulse' }}">
            </view>
            <text
              class="text-20rpx font-medium {{ item.lastBuyStatus.isSafe ? 'text-hex-6B7280' : 'text-hex-F59E0B' }}">
              {{ item.lastBuyStatus.label }}
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <van-toast id="van-toast" />
</view>